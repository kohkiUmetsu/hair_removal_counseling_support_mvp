# Ticket-10: Analysis Features - Improvement Suggestions

## 概要
AI分析結果に基づく包括的な改善提案機能とスクリプト最適化機能を実装しました。

## 実装内容

### 1. 改善提案サービス (`app/services/improvement_service.py`)
分析結果から個別化された改善提案を自動生成：

#### 主要機能
- **カテゴリ別改善提案**: 質問技法、不安対応、クロージング、フローの4分野
- **優先度付け**: HIGH/MEDIUM/LOWの3段階
- **具体的なスクリプト例**: 実践可能な会話例を提供
- **成功パターン学習**: 過去の高スコアセッションから成功要因を抽出
- **パフォーマンストレンド分析**: 個人の改善軌跡を追跡

#### 改善提案の生成ロジック
```python
# 各分野で7.0未満のスコアに対して改善提案を生成
if analysis_result.questioning.score < 7.0:
    suggestions.extend(self._generate_questioning_suggestions())

# 優先度とインパクトでソート
suggestions.sort(key=lambda x: (
    self._get_priority_weight(x.priority),
    x.expected_impact_score
), reverse=True)
```

### 2. スクリプト最適化サービス (`app/services/script_optimization_service.py`)
顧客特性と成功パターンに基づく最適化スクリプト生成：

#### 主要機能
- **顧客プロファイル分析**: 不安レベル、決断スタイル、価格感度を分析
- **動的スクリプト生成**: 5つのセクション（オープニング、ニーズ把握、提案、異議処理、クロージング）
- **成功確率予測**: 過去データに基づく成約確率算出
- **カスタマイズノート**: 個別対応のガイダンス

#### スクリプト構成
1. **オープニング**: 信頼関係構築とリラックス環境作り
2. **ニーズアセスメント**: 顧客の真のニーズと不安の深掘り
3. **プレゼンテーション**: ニーズに合わせた解決策提示
4. **異議処理**: 料金・痛みなど主要な懸念への対応
5. **クロージング**: 適切なタイミングでの決断促進

### 3. 改善提案スキーマ (`app/schemas/improvement.py`)
包括的なデータ構造を定義：

#### 主要スキーマ
- **Suggestion**: 個別改善提案（優先度、カテゴリ、具体例、期待効果）
- **OptimizedScript**: 最適化スクリプト（各セクション + 成功確率）
- **SuccessPatternData**: 成功パターン（タイプ、成功率、効果スコア）
- **PerformanceTrend**: パフォーマンス傾向（改善率、注意領域）

### 4. API エンドポイント (`app/api/improvement.py`)
- `GET /api/v1/improvement/{analysis_id}/suggestions` - 改善提案取得
- `POST /api/v1/improvement/generate-script` - 最適化スクリプト生成
- `GET /api/v1/improvement/success-patterns` - 成功パターン取得
- `POST /api/v1/improvement/feedback` - フィードバック送信
- `GET /api/v1/improvement/performance-trends/{counselor_id}` - パフォーマンストレンド

## 詳細機能

### 改善提案の生成基準

#### 質問技法の改善提案
- **オープンクエスチョン比率 < 0.6**: 「はい・いいえ」以外の質問を増やす
- **顧客発話時間 < 0.5**: より多く話してもらう技法を提案
- **質問多様性 < 5**: 5W1Hなど多角的な質問を推奨

#### 不安対応の改善提案
- **不安要素特定 < 3件**: より詳細な不安の把握を推奨
- **共感表現 < 3回**: より多くの共感的対応を提案
- **解決策具体性 < 0.7**: 数値や実例を使った具体的説明を推奨

#### クロージングの改善提案
- **タイミング適切性 < 0.7**: 顧客の準備状況確認を推奨
- **緊急性演出 < 0.6**: 期間限定や予約枠の活用を提案
- **限定性活用 < 0.6**: 特別感を演出する技法を推奨

### スクリプト最適化アルゴリズム

#### 顧客特性の分析
```python
# 過去のセッション分析から特性を抽出
anxiety_level = (10 - avg_anxiety_score) / 10  # 不安レベル算出
communication_preference = "detailed" if avg_score > 7.0 else "simple"
```

#### 成功確率の計算
```python
base_probability = 0.6  # ベース確率
base_probability -= anxiety_level * 0.2  # 不安による減算
base_probability += pattern_boost  # 成功パターンによる加算
```

### 成功パターン学習機能

#### 高スコアセッションの分析
- **閾値**: 8.0以上のスコアを成功基準とする
- **パターン抽出**: 70%以上の成功率で成功パターン認定
- **継続的学習**: 30日周期でパターンを更新

#### 学習対象
- **質問パターン**: 効果的な質問の構造とタイミング
- **不安対応パターン**: 高い安心感を与える対応方法
- **クロージングパターン**: 成約率の高いクロージング技法

## セキュリティ・権限制御

### 役割別アクセス制御
- **counselor**: 自分のクリニックのデータのみアクセス可能
- **manager**: 管轄クリニックのデータのみアクセス可能
- **admin**: 全データにアクセス可能

### データ保護
- 個人情報を含まない改善提案の生成
- フィードバックデータの匿名化
- セッション データの暗号化保存

## API 使用例

### 改善提案の取得
```python
GET /api/v1/improvement/abc123/suggestions?max_suggestions=5&focus_categories=questioning,closing
```

### スクリプト生成
```python
POST /api/v1/improvement/generate-script
{
  "customer_profile": {
    "anxiety_level": 0.8,
    "decision_making_style": "analytical"
  },
  "session_type": "initial_consultation",
  "focus_areas": ["anxiety_handling", "closing"]
}
```

### 成功パターン取得
```python
GET /api/v1/improvement/success-patterns?days=30&min_score=8.0
```

## パフォーマンス要件

### 処理時間
- 改善提案生成: 1秒以内
- スクリプト最適化: 2秒以内
- 成功パターン分析: 3秒以内

### スケーラビリティ
- 同時リクエスト: 50件まで対応
- データ保持期間: 過去1年分
- キャッシュ活用: 頻繁なクエリの高速化

## 今後の拡張予定

### 機械学習の強化
1. **自然言語処理**: 文字起こしテキストからの詳細パターン抽出
2. **予測モデル**: より精度の高い成功確率予測
3. **パーソナライゼーション**: 個人特性に最適化されたアドバイス

### 実時間フィードバック
1. **ライブコーチング**: セッション中のリアルタイム提案
2. **音声分析**: 話し方や間の取り方の分析
3. **感情分析**: 顧客の感情状態に基づく動的調整

### 統合分析
1. **複数セッション分析**: 長期的な成長トレンド
2. **チーム比較**: クリニック内でのベンチマーク
3. **業界比較**: 業界標準との比較分析

## 品質保証

### テスト項目
- ✅ 改善提案の妥当性（専門家による評価）
- ✅ スクリプトの実用性（カウンセラーによる評価）
- ✅ 成功パターンの精度（統計的検証）
- ✅ API のパフォーマンス（負荷テスト）

### 監視項目
- 提案の採用率
- スクリプト使用効果
- パフォーマンス改善率
- システム応答時間

## 完了
✅ 分析結果に基づく改善提案機能とスクリプト最適化機能の実装完了