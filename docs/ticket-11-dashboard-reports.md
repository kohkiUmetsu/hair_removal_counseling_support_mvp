# Ticket-11: Dashboard & Reports - Analytics Dashboard

## 概要
管理者、マネージャー、カウンセラー向けの包括的な分析ダッシュボードとレポート機能を実装しました。

## 実装内容

### 1. 分析サービス (`app/services/analytics_service.py`)
データ処理と集計を担当する核となるサービス：

#### 主要機能
- **KPI計算**: 成約率、平均スコア、売上、顧客満足度
- **トレンド分析**: 日別、週別、月別のパフォーマンス推移
- **パフォーマンス比較**: カウンセラー間、クリニック間の比較
- **品質メトリクス**: 文字起こし精度、分析信頼性、ユーザー満足度
- **リアルタイム監視**: システム健全性、処理キューの状況

#### データ集計アルゴリズム
```python
# 成約率計算
conversion_rate = high_score_sessions / total_sessions

# 平均スコア計算
average_score = sum(scores) / len(scores)

# 改善率計算（前期間比）
improvement_rate = (current_avg - prev_avg) / prev_avg * 100
```

### 2. ダッシュボードスキーマ (`app/schemas/dashboard.py`)
包括的なデータ構造を定義：

#### 主要スキーマ
- **ExecutiveDashboard**: 経営陣向け統合ダッシュボード
- **CounselorDashboard**: カウンセラー個人向けダッシュボード
- **OperationDashboard**: 運用監視ダッシュボード
- **PerformanceReport**: 詳細パフォーマンスレポート
- **TrendAnalysis**: トレンド分析結果

### 3. API エンドポイント (`app/api/dashboard.py`)
- `GET /api/v1/dashboard/executive` - エグゼクティブダッシュボード
- `GET /api/v1/dashboard/counselor/{counselor_id}` - カウンセラーダッシュボード
- `GET /api/v1/dashboard/operations` - オペレーションダッシュボード
- `GET /api/v1/dashboard/performance-report` - パフォーマンスレポート
- `POST /api/v1/dashboard/custom-report` - カスタムレポート作成
- `GET /api/v1/dashboard/trends` - トレンド分析
- `POST /api/v1/dashboard/export` - データエクスポート

## 詳細機能

### エグゼクティブダッシュボード
経営陣向けの高レベル分析画面：

#### KPI メトリクス
- **成約率**: 高スコア（8.0以上）セッションの割合
- **平均セッションスコア**: 全セッションの分析スコア平均
- **月間売上**: 成約数 × 単価での推定売上
- **顧客満足度**: 分析スコア7.0以上の割合から算出

#### トレンド分析
- **日別パフォーマンス**: 過去30日間の詳細推移
- **成約率トレンド**: 時系列での成約率変化
- **売上トレンド**: 推定売上の推移
- **スコアトレンド**: 品質向上の状況

#### トップパフォーマー
- **ランキング**: 平均スコア順でのカウンセラー順位
- **セッション数**: 期間内の対応セッション数
- **改善率**: 前期間からの成長率

### カウンセラーダッシュボード
個人のパフォーマンス詳細分析：

#### 個人統計
- **総セッション数**: 期間内の対応数
- **平均スコア**: 個人の分析スコア平均
- **成約率**: 個人の成約達成率
- **改善率**: 前期間からの成長度

#### スキル分析
- **質問技法**: オープンクエスチョン、深掘り質問の評価
- **不安対応**: 共感表現、解決策提示の評価
- **クロージング**: タイミング、緊急性演出の評価
- **トーク流れ**: 論理構成、転換スムーズさの評価

#### 個別推奨事項
- スキル分析結果に基づく改善提案
- 強みの維持と弱点克服のアドバイス
- 次回レビュー日の設定

### オペレーションダッシュボード
システム運用監視画面：

#### リアルタイムメトリクス
- **アクティブセッション**: 当日のセッション数
- **処理キュー**: 分析待ちタスク数
- **システム健全性**: エラー率に基づくステータス
- **最終更新時刻**: データ更新タイムスタンプ

#### セッション分析
- **日別ボリューム**: 過去7日間のセッション数推移
- **平均処理時間**: 分析タスクの所要時間
- **エラー率**: 失敗タスクの割合
- **週間タスク数**: 1週間の総処理数

#### 品質メトリクス
- **文字起こし精度**: 完了率から推定した精度
- **分析信頼性**: 成功した分析の割合
- **ユーザー満足度**: フィードバックに基づく満足度
- **データ完全性**: システムデータの整合性

## データ処理とパフォーマンス

### 集計処理の最適化
```python
# SQLクエリの最適化
query = db.query(SessionModel).filter(
    SessionModel.session_date >= start_date,
    SessionModel.session_date <= end_date
).join(Customer).filter(
    Customer.clinic_id == clinic_id
)

# インデックスを活用した高速集計
results = query.group_by(
    func.date(SessionModel.session_date)
).all()
```

### キャッシュ戦略
- **頻繁なクエリ**: Redis による1時間キャッシュ
- **重い集計処理**: 結果の一時保存
- **リアルタイムデータ**: キャッシュ無効化の実装

### パフォーマンス要件
- **初期表示**: 3秒以内
- **データ更新**: 1秒以内
- **同時ユーザー**: 20ユーザーまで対応
- **データ保持**: 1年間の履歴データ

## セキュリティと権限制御

### 役割別アクセス制御
```python
# カウンセラー: 自分のデータのみ
if current_user.role == "counselor":
    counselor_ids = [str(current_user.id)]

# マネージャー: 管轄クリニックのみ
elif current_user.role == "manager":
    clinic_ids = [current_user.clinic_id]

# 管理者: 全データアクセス可能
```

### データ保護
- **個人情報マスキング**: 統計データでの個人特定防止
- **クリニック間分離**: データ漏洩防止
- **監査ログ**: アクセス履歴の記録

## レポート機能

### パフォーマンスレポート
#### カウンセラーレポート
- 個人別詳細統計
- スキル分析結果
- 改善推奨事項
- 同僚との比較

#### クリニックレポート
- クリニック別パフォーマンス
- カウンセラー間比較
- ベストプラクティス抽出
- 改善機会の特定

#### 顧客レポート
- 顧客満足度分析
- セグメント別統計
- リピート率分析
- 成約要因分析

### カスタムレポート
ユーザー定義の柔軟なレポート作成：

#### 設定可能項目
- **メトリクス**: 分析したい指標の選択
- **ディメンション**: 分析軸の設定
- **フィルター**: 期間、クリニック、カウンセラーなど
- **可視化タイプ**: テーブル、グラフ、ヒートマップ

#### 集計方法
- **SUM**: 合計値計算
- **AVG**: 平均値計算
- **COUNT**: 件数集計
- **MIN/MAX**: 最小値・最大値

### データエクスポート
多様な形式でのデータ出力：

#### 対応形式
- **CSV**: Excel での分析用
- **PDF**: 印刷・共有用レポート
- **Excel**: 高度な分析用
- **JSON**: システム連携用

#### バックグラウンド処理
```python
# 大容量データの非同期エクスポート
background_tasks.add_task(
    _process_export,
    export_id=export_id,
    request=request,
    user_id=str(current_user.id)
)
```

## トレンド分析

### 時系列分析
- **短期トレンド**: 7日間の日次変化
- **中期トレンド**: 30日間の週次変化
- **長期トレンド**: 1年間の月次変化

### 統計分析
- **平均値**: 期間内の平均パフォーマンス
- **標準偏差**: パフォーマンスのばらつき
- **変化率**: 前期間からの変化量
- **信頼区間**: 統計的な信頼性評価

### 予測機能（将来実装予定）
- **線形回帰**: 単純なトレンド予測
- **移動平均**: 短期変動の平滑化
- **季節調整**: 季節要因の除去
- **機械学習**: 高度な予測モデル

## API 使用例

### エグゼクティブダッシュボード取得
```python
GET /api/v1/dashboard/executive?start_date=2024-06-01&end_date=2024-06-30&clinic_id=abc123
```

### カウンセラーダッシュボード取得
```python
GET /api/v1/dashboard/counselor/user123?start_date=2024-06-01&end_date=2024-06-30
```

### カスタムレポート作成
```python
POST /api/v1/dashboard/custom-report
{
  "metrics": ["average_score", "conversion_rate"],
  "dimensions": ["counselor", "clinic"],
  "filters": {
    "start_date": "2024-06-01",
    "end_date": "2024-06-30"
  },
  "visualization_type": "chart"
}
```

## 品質保証とテスト

### テスト項目
- ✅ ダッシュボードの正確な表示
- ✅ 統計計算の妥当性
- ✅ 権限制御の動作
- ✅ パフォーマンス要件の満足
- ✅ エクスポート機能の動作
- ✅ リアルタイム更新の機能

### 監視項目
- **レスポンス時間**: APIの応答速度
- **エラー率**: 失敗したリクエストの割合
- **データ整合性**: 集計結果の正確性
- **ユーザー利用状況**: アクセス頻度と利用パターン

## 今後の拡張予定

### 高度な分析機能
1. **機械学習**: より精度の高い予測モデル
2. **異常検知**: パフォーマンス異常の自動検出
3. **クラスタリング**: 類似パターンの自動分類
4. **相関分析**: 要因間の関係性分析

### ユーザビリティ向上
1. **インタラクティブチャート**: ドリルダウン機能
2. **カスタマイズ可能ダッシュボード**: ウィジェット配置
3. **アラート機能**: 閾値超過時の自動通知
4. **モバイル対応**: スマートフォンでの閲覧

### 外部連携
1. **CRM連携**: 顧客管理システムとの連携
2. **会計システム**: 売上データの自動連携
3. **BI ツール**: PowerBI、Tableau等との連携
4. **API 提供**: 外部システムからのデータ取得

## 完了
✅ 管理者向けダッシュボードとレポート機能の実装完了